<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Leaflet — Ortho RAW vs COG (avec fond satellite)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body,#map { height:100%; margin:0; padding:0; font-family: "Segoe UI", Roboto, Arial, sans-serif; }
    #map { position: absolute; top:0; right:0; bottom:0; left:0; }
    #controls {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 1400;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      min-width: 210px;
    }
    #controls h3 { margin:0 0 8px 0; font-size:14px }
    #controls label { display:block; margin:6px 0 }
  </style>
</head>
<body>
<div id="map"></div>

<div id="controls">
  <h3>Ortho viewer</h3>
  <label><input type="radio" name="source" value="COG" checked> Orthophoto_COG</label>
  <label><input type="radio" name="source" value="RAW"> Orthophoto (RAW)</label>

  <label style="margin-top:8px"><strong>Style</strong></label>
  <select id="styleSelect">
    <option value="stylergb">RGB</option>
    <option value="stylecolormap">ColorMap</option>
    <option value="stylendvi">NDVI-like</option>
    <option value="stylegris">Grayscale</option>
  </select>

  <label style="margin-top:8px"><strong>Opacité</strong></label>
  <input id="opacityRange" type="range" min="0" max="1" step="0.05" value="1">
  <button id="updateBtn">Mettre à jour</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Configuration
const GEOSERVER_BASE = 'http://localhost:8080/geoserver';
const WORKSPACE = 'WebMapping3';
const LAYER_RAW = 'Orthophoto';
const LAYER_COG = 'Orthophoto_COG';

// Emprise géographique fournie (lat/lon)
const BBOX = {
  minLon: 8.552366795955,
  minLat: 47.383176937364,
  maxLon: 8.5566222193638,
  maxLat: 47.386394106152
};

// Initialise la carte sans setView — on va utiliser fitBounds pour cadrer l'orthophoto
const map = L.map('map', { zoomControl: true });

// --- FOND SATELLITE (Esri World Imagery) ---
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Esri World Imagery',
  maxZoom: 22
}).addTo(map);

let overlay = null;

function makeWMS(layerName, style) {
  return L.tileLayer.wms(`${GEOSERVER_BASE}/wms`, {
    layers: `${WORKSPACE}:${layerName}`,
    styles: style,
    format: 'image/png',
    transparent: true,
    version: '1.1.1',
    tiled: true
  });
}

function refresh() {
  // defensive: ensure DOM controls exist
  const srcEl = document.querySelector('input[name=source]:checked');
  const styleEl = document.getElementById('styleSelect');
  const opacityEl = document.getElementById('opacityRange');
  if (!srcEl || !styleEl || !opacityEl) return;

  const src = srcEl.value;
  const style = styleEl.value;
  const layer = (src === 'COG') ? LAYER_COG : LAYER_RAW;

  if (overlay) {
    try { map.removeLayer(overlay); } catch(e) { /* ignore */ }
    overlay = null;
  }

  overlay = makeWMS(layer, style);
  // setOpacity may not exist on some layer types, guard it
  const op = parseFloat(opacityEl.value) || 1;
  if (overlay && typeof overlay.setOpacity === 'function') overlay.setOpacity(op);
  overlay.addTo(map);
}

// Hook events once DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  const updateBtn = document.getElementById('updateBtn');
  const styleSelect = document.getElementById('styleSelect');
  const opacityRange = document.getElementById('opacityRange');

  if (updateBtn) updateBtn.addEventListener('click', refresh);
  if (styleSelect) styleSelect.addEventListener('change', refresh);
  if (opacityRange) opacityRange.addEventListener('input', refresh);

  // Cadrage automatique sur l'emprise de l'orthophoto (fitBounds attend [[southWestLat, southWestLon],[northEastLat, northEastLon]])
  const southWest = [BBOX.minLat, BBOX.minLon];
  const northEast = [BBOX.maxLat, BBOX.maxLon];
  map.fitBounds([southWest, northEast]);

  // ajouter l'overlay initial
  refresh();
});
</script>
</body>
</html>
